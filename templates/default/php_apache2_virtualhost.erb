# Generated by Chef for <%= node[:fqdn] %>.
<VirtualHost *:<%= @params[:port] %>>
  
  <% if @params[:permanent_redirect] %>
    Redirect permanent / <%= @params[:permanent_redirect] %>  
  <% end %>

  ServerName <%= @params[:server_name] %>	
  
  <% if @params[:server_aliases] %>
    ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
  <% end %>

<% if @params[:aliases] %>
    <% @params[:aliases].each do |a| %>
      
      <%="Alias #{a.name}"%> <%="\"#{a.path}\"" %>

      <Directory "<%="#{a.path}"%>">
        Options ExecCGI FollowSymLinks
        Order allow,deny
        Allow from all
        <IfModule mod_fcgid.c>
          AddHandler fcgid-script .php
          FCGIWrapper /usr/lib/cgi-bin/php5 .php
        </IfModule>
      </Directory>

    <% end %>
  <% end %>


  <% if @params[:ssl] == "on" %>
   #  Enable SSL
    SSLEngine On
    SSLCertificateFile <%= @params[:ssl_certificate_file] %>  
    SSLCertificateKeyFile <%= @params[:ssl_certificate_key_file] %>  
    SSLCACertificateFile <%= @params[:ssl_ca_certificate_file] %>  
  <% end %>
    
  DocumentRoot <%= @params[:docroot] %>
  
    <Directory <%= @params[:docroot] %>>
      Options ExecCGI FollowSymLinks
  	
  	<IfModule mod_fcgid.c>
      	AddHandler fcgid-script .php
      	FCGIWrapper /usr/lib/cgi-bin/php5 .php
  	</IfModule>
      
  	  AllowOverride All
     # Order allow,deny
     # Allow from all
    
    </Directory>
  
    <Directory />
      Options FollowSymLinks
      AllowOverride None
    </Directory>
	
  LogLevel warn
  ErrorLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-access.log combined
  ServerSignature Off
  
  <IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
    RewriteLogLevel 0
    
    #  Enable this if you want all requests to this server to be routed to this address (apache will rewrite them)
    #  Canonical host, <%= @params[:server_name] %>
    
    <% if @params[:domain_redirect] %>
    
          RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
          RewriteCond %{HTTP_HOST}   !^$
        <% if @params[:ssl] == "on" %>
          RewriteRule ^/(.*)$        https://<%= @params[:server_name] %>/$1 [L,R=301]
        <% else %>  
          RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]
        <% end %>
    
    <% else %>  
    
        #  RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
        #  RewriteCond %{HTTP_HOST}   !^$
        <% if @params[:ssl] == "on" %>
        #  RewriteRule ^/(.*)$        https://<%= @params[:server_name] %>/$1 [L,R=301]
        <% else %>  
        #  RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]
        <% end %>
    
    <% end %>

  </IfModule>

</VirtualHost>